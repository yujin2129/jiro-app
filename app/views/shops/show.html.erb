<h2><%= @shop.name %></h2>
<p><strong>評価:</strong>
  <% if @shop.reviews.exists? %>
    <% stars = @shop.average_rating_stars %>
    <% 5.times do |i| %>
      <% if i < stars %>
        <span class="text-warning">★</span>
      <% else %>
        <span class="text-secondary">☆</span>
      <% end %>
    <% end %>
    <span class="ms-2"><%= @shop.average_rating %> / 5</span>
  <% else %>
    <span>まだ評価がありません</span>
  <% end %>
</p>
<p><strong>住所:</strong> <%= @shop.address %></p>
<p><strong>営業時間:</strong> <%= @shop.opening_hours %></p>
<p><strong>定休日:</strong> <%= @shop.holiday %></p>
<p><strong>ルール:</strong> <%= @shop.rules %></p>

<% if @shop.image.attached? %>
  <div>
    <%= image_tag @shop.image.variant(resize_to_limit: [600, 400]) %>
  </div>
<% end %>

<div id="favorite_button">
  <%= render "favorite_button", shop: @shop %>
</div>

<%= link_to '編集', edit_shop_path(@shop), class: 'btn btn-warning' %>
<%= link_to '一覧に戻る', shops_path, class: 'btn btn-secondary' %>

<h2 class="mt-4">レビュー</h2>

<% if user_signed_in? %>
  <%= form_with model: [@shop, Review.new], local: true do |f| %>
    <div class="mb-3">
      <%= f.label :rating, "評価（1〜5）" %>
      <%= f.number_field :rating, in: 1..5, class: "form-control" %>
    </div>
    <div class="mb-3">
      <%= f.label :content, "レビュー内容" %>
      <%= f.text_area :content, class: "form-control" %>
    </div>
    <%= f.submit "投稿", class: "btn btn-primary" %>
  <% end %>
<% else %>
  <p>レビュー投稿にはログインが必要です。</p>
<% end %>

<hr>

<h3>混雑情報を投稿する</h3>
<%= form_with model: [@shop, Congestion.new], local: true do |f| %>
  <div class="mb-3">
    <%= f.label :visited_on, "訪問日" %>
    <%= f.date_field :visited_on, class: "form-control" %>
  </div>
  <div class="mb-3">
    <%= f.label :visited_time, "訪問時間帯" %>
    <%= f.select :visited_time, [
      "0:00〜2:00", "2:00〜4:00", "4:00〜6:00",
      "6:00〜8:00", "8:00〜10:00", "10:00〜12:00",
      "12:00〜14:00", "14:00〜16:00", "16:00〜18:00",
      "18:00〜20:00", "20:00〜22:00", "22:00〜24:00"
    ], {}, class: "form-control" %>
  </div>
  <div class="mb-3">
    <%= f.label :level, "混雑度（1〜5）" %>
    <%= f.number_field :level, in: 1..5, class: "form-control" %>
  </div>
  <%= f.submit "投稿", class: "btn btn-primary" %>
<% end %>

<hr>

<% @reviews.each do |review| %>
  <div class="border rounded p-2 mb-2">
    <strong><%= review.user.name %></strong>（評価: <%= review.rating %>）  
    <p><%= review.content %></p>
    <% if review.user == current_user && review.id.present? %>
      <%= button_to "削除", shop_review_path(@shop, review), method: :delete, data: { turbo_confirm: "削除しますか？" }, class: "btn btn-sm btn-outline-danger" %>
    <% end %>
  </div>
<% end %>
