<h2 class="mb-3 font-jiro"><%= @shop.name %></h2>

<ul class="nav nav-pills nav-fill mb-3" id="shopTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
      type="button" role="tab" aria-controls="info" aria-selected="true">
      店舗情報
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="congestion-tab" data-bs-toggle="tab" data-bs-target="#congestion"
      type="button" role="tab" aria-controls="congestion" aria-selected="false">
      混雑情報
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews"
      type="button" role="tab" aria-controls="reviews" aria-selected="false">
      レビュー
    </button>
  </li>
</ul>

<div class="tab-content" id="shopTabContent">

  <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
    <div class="card p-3 mb-3 border border-dark bg-light-subtle">
      <div class="mb-2">
        <i class="bi bi-star-fill text-warning me-1"></i>
        <strong>評価:</strong> <%= render "shops/star_rating", shop: @shop %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-geo-alt-fill text-danger me-1"></i>
        <strong>住所:</strong> <%= @shop.address %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-clock-fill text-primary me-1"></i>
        <strong>営業時間:</strong> <%= @shop.opening_hours %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-calendar-event-fill text-secondary me-1"></i>
        <strong>定休日:</strong> <%= @shop.holiday %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-journal-text me-1"></i>
        <strong>メニュー:</strong><br>
        <%= simple_format(@shop.menu) %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-card-list me-1"></i>
        <strong>ルール:</strong><br>
        <%= simple_format(@shop.rules) %>
      </div>

      <% if @shop.image.attached? %>
        <%= image_tag @shop.image.variant(resize_to_limit: [600, 400]), class: "img-fluid rounded mb-3" %>
      <% end %>

      <div id="map" style="height: 400px; width: 100%; margin-bottom: 1rem;"></div>
      <p id="shop-address" style="display: none;"><%= @shop.address %></p>

      <div id="favorite_button" class="mt-2">
        <%= render "favorite_button", shop: @shop %>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="congestion" role="tabpanel" aria-labelledby="congestion-tab">
    <ul class="nav nav-tabs mt-2" id="congestionDayTab" role="tablist">
      <% days = %w(日 月 火 水 木 金 土) %>
      <% days.each_with_index do |day, index| %>
        <li class="nav-item" role="presentation">
          <button class="nav-link <%= 'active' if index == 0 %>" id="day-<%= index %>-tab"
                  data-bs-toggle="tab" data-bs-target="#day-<%= index %>"
                  type="button" role="tab" aria-controls="day-<%= index %>" aria-selected="<%= index == 0 %>">
            <%= day %>
          </button>
        </li>
      <% end %>
    </ul>

    <div class="tab-content mt-2" id="congestionDayTabContent">
      <% days.each_with_index do |day, index| %>
        <div class="tab-pane fade <%= 'show active' if index == 0 %>" id="day-<%= index %>" role="tabpanel" aria-labelledby="day-<%= index %>-tab">
          <% grouped = @congestions_by_day[index] || [] %>
          <% if grouped.any? %>
            <% Congestion::VISITED_TIME_SLOTS.each do |time| %>
              <% time_congestions = grouped.select { |c| c.visited_time == time } %>
              <% next if time_congestions.empty? %>
              <div class="mb-2">
                <strong><%= time %></strong>：
                平均混雑度：<%= (time_congestions.sum(&:level).to_f / time_congestions.size).round(1) %>
                （<%= time_congestions.size %>件）
              </div>
            <% end %>
          <% else %>
            <p>データがありません</p>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="card p-3 mt-3 border border-dark bg-warning-light">
      <h5>混雑情報を投稿</h5>
      <%= form_with model: [@shop, Congestion.new], local: true do |f| %>
        <div class="mb-2">
          <%= f.label :visited_on %>
          <%= f.date_field :visited_on, class: "form-control" %>
        </div>
        <div class="mb-2">
          <%= f.label :visited_time %>
          <%= f.select :visited_time, Congestion::VISITED_TIME_SLOTS, {}, class: "form-control" %>
        </div>
        <div class="mb-2">
          <%= f.label :level %>
          <%= f.number_field :level, in: 1..5, class: "form-control" %>
        </div>
        <%= f.submit "投稿", class: "btn btn-dark" %>
      <% end %>
    </div>
  </div>

  <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
    <% @shop.reviews.each do |review| %>
      <div class="card mb-2 bg-light border border-dark">
        <div class="card-body p-2">
          <strong><%= review.user.name %></strong>
          <span class="ms-2">評価: <%= review.rating %></span>
          <p class="mb-0"><%= review.content %></p>
        </div>
      </div>
    <% end %>

    <div class="card p-3 mt-3 border border-dark bg-light-subtle">
      <h5>レビューを投稿</h5>
      <%= form_with model: [@shop, Review.new], local: true do |f| %>
        <div class="mb-2">
          <%= f.label :rating %>
          <%= f.number_field :rating, in: 1..5, class: "form-control" %>
        </div>
        <div class="mb-2">
          <%= f.label :content %>
          <%= f.text_area :content, class: "form-control" %>
        </div>
        <%= f.submit "投稿", class: "btn btn-warning" %>
      <% end %>
    </div>
  </div>

</div>
