<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0"><%= @shop.name %></h2>

  <div class="d-flex align-items-center">
    <%= link_to "戻る", request.referer || shops_path, class: "btn btn-outline-secondary me-2" %>
    <%= link_to "混雑情報を投稿", new_shop_congestion_path(@shop), class: "btn btn-outline-dark me-2" %>
    <%= link_to "レビューを投稿", new_shop_review_path(@shop), class: "btn btn-warning" %>
  </div>
</div>

<ul class="nav nav-pills nav-fill mb-3" id="shopTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info"
      type="button" role="tab" aria-controls="info" aria-selected="true">
      店舗情報
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="congestion-tab" data-bs-toggle="tab" data-bs-target="#congestion"
      type="button" role="tab" aria-controls="congestion" aria-selected="false">
      混雑情報
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews"
      type="button" role="tab" aria-controls="reviews" aria-selected="false">
      レビュー
    </button>
  </li>
</ul>

<div class="tab-content" id="shopTabContent">

  <div class="tab-pane fade show active" id="info" role="tabpanel" aria-labelledby="info-tab">
    <div class="card p-3 mb-3 border border-dark bg-light-subtle">
      <div class="mb-2">
        <i class="bi bi-star-fill text-warning me-1"></i>
        <strong>評価:</strong> <%= render "shops/star_rating", shop: @shop %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-geo-alt-fill text-danger me-1"></i>
        <strong>住所:</strong> <%= @shop.address %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-clock-fill text-primary me-1"></i>
        <strong>営業時間:</strong> <%= @shop.opening_hours %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-calendar-event-fill text-secondary me-1"></i>
        <strong>定休日:</strong> <%= @shop.holiday %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-journal-text me-1"></i>
        <strong>メニュー:</strong><br>
        <%= simple_format(@shop.menu) %>
      </div>
    
      <div class="mb-2">
        <i class="bi bi-card-list me-1"></i>
        <strong>ルール:</strong><br>
        <%= simple_format(@shop.rules) %>
      </div>

      <% if @shop.images.attached? %>
        <h5>店舗画像</h5>
          <div class="shop-images d-flex flex-wrap gap-2 mt-2">
            <% @shop.images.each do |image| %>
              <%= image_tag image.variant(resize_to_limit: [300, 200]),
                            class: "img-thumbnail" %>
            <% end %>
          </div>
      <% end %>

      <div id="map" style="height: 400px; width: 100%; margin-bottom: 1rem;"></div>
      <p id="shop-address" style="display: none;"><%= @shop.address %></p>

      <div id="favorite_button" class="mt-2">
        <%= render "shops/favorite_button", shop: @shop %>
      </div>

      <% if user_signed_in? && current_user.admin? %>
        <div class="mt-3 d-flex justify-content-end">
          <%= link_to "編集", edit_shop_path(@shop), class: "btn btn-sm btn-outline-secondary me-2" %>
          <%= button_to "削除", shop_path(@shop), method: :delete,
                        data: { turbo_confirm: "本当に削除しますか？" },
                        class: "btn btn-sm btn-outline-danger" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="tab-pane fade" id="congestion" role="tabpanel" aria-labelledby="congestion-tab">
    <ul class="nav nav-tabs" id="congestionTab" role="tablist">
      <% days = %w(日 月 火 水 木 金 土) %>
      <% days.each_with_index do |day, index| %>
        <li class="nav-item" role="presentation">
          <button class="nav-link <%= 'active' if index == 0 %>" 
                  id="day-<%= index %>-tab"
                  data-bs-toggle="tab" 
                  data-bs-target="#day-<%= index %>"
                  type="button" role="tab" 
                  aria-controls="day-<%= index %>" 
                  aria-selected="<%= index == 0 %>">
            <%= day %>
          </button>
        </li>
      <% end %>
    </ul>

    <div class="tab-content mt-3" id="congestionTabContent">
      <% days.each_with_index do |day, index| %>
        <div class="tab-pane fade <%= 'show active' if index == 0 %>" 
             id="day-<%= index %>" role="tabpanel" 
             aria-labelledby="day-<%= index %>-tab">

          <% grouped = @congestions_by_day[index] || [] %>

          <table class="congestion-table table-sm text-center">
            <thead>
              <tr>
                <th>時間帯</th>
                <% (1..5).each do |level| %>
                  <th><%= CongestionsHelper::CONGESTION_LEVEL_LABELS[level] %></th>
                <% end %>   
              </tr>
            </thead>
            <tbody>
              <% Congestion::VISITED_TIME_SLOTS.each do |time| %>
                <tr>
                  <td class="fw-bold"><%= time %></td>

                  <% counts = (1..5).map { |level| grouped.count { |c| c.visited_time == time && c.level == level } } %>
                  <% max_count = counts.max %>

                  <% (1..5).each_with_index do |level, idx| %>
                    <% count = counts[idx] %>
                    <td class="<%= 'highlight' if count == max_count && count > 0 %>">
                      <% if count > 0 %>
                        <strong><%= "#{count}件" %></strong>
                      <% else %>
                        <span class="text-muted">0件</span>
                      <% end %>
                    </td>
                  <% end %>

                </tr>
              <% end %>
            </tbody>
          </table>

        </div>
      <% end %>
    </div>

  </div>

  <div class="tab-pane fade" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
    <% @shop.reviews.each do |review| %>
      <div class="card mb-2 bg-light border border-dark">
        <div class="card-body p-2">
          <strong><%= review.user.name %></strong>
          <span class="ms-2"><%= render "shops/star_rating", rating: review.rating %></span>
          <p class="mb-0"><%= review.content %></p>
          <% if review.persisted? && review.images.attached? %>
            <div class="mt-2 d-flex flex-wrap">
              <% review.images.each do |image| %>
                <%= image_tag image.variant(resize_to_limit: [200, 200]),
                      class: "img-thumbnail me-2 mb-2" %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

  </div>

</div>
