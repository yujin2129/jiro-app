<h2><%= @shop.name %></h2>
<p><strong>評価:</strong>
  <%= render "star_rating", shop: @shop %>
</p>
<p><strong>住所:</strong> <%= @shop.address %></p>
<p><strong>営業時間:</strong> <%= @shop.opening_hours %></p>
<p><strong>定休日:</strong> <%= @shop.holiday %></p>
<p><strong>メニュー:</strong><br><%= simple_format(@shop.menu) %></p>
<p><strong>ルール:</strong> <%= @shop.rules %></p>

<div id="map" style="height: 400px; width: 100%;"></div>
<p id="shop-address" style="display: none;"><%= @shop.address %></p>

<% if @shop.image.attached? %>
  <div>
    <%= image_tag @shop.image.variant(resize_to_limit: [600, 400]) %>
  </div>
<% end %>

<div id="favorite_button">
  <%= render "favorite_button", shop: @shop %>
</div>

<h2 class="mt-4">混雑情報</h2>

<% days = %w(日 月 火 水 木 金 土) %>

<ul class="nav nav-tabs" id="congestionTab" role="tablist">
  <% days.each_with_index do |day, index| %>
    <li class="nav-item" role="presentation">
      <button class="nav-link <%= 'active' if index == 0 %>" id="day-<%= index %>-tab"
        data-bs-toggle="tab" data-bs-target="#day-<%= index %>"
        type="button" role="tab" aria-controls="day-<%= index %>" aria-selected="<%= index == 0 %>">
        <%= day %>
      </button>
    </li>
  <% end %>
</ul>

<div class="tab-content mt-3" id="congestionTabContent">
  <% days.each_with_index do |day, index| %>
    <div class="tab-pane fade <%= 'show active' if index == 0 %>" id="day-<%= index %>" role="tabpanel"
      aria-labelledby="day-<%= index %>-tab">

      <% grouped = @congestions_by_day[index] || [] %>
      <% if grouped.any? %>
        <% Congestion::VISITED_TIME_SLOTS.each do |time| %>
          <% time_congestions = grouped.select { |c| c.visited_time == time } %>
          <% next if time_congestions.empty? %>
          <div class="mb-2">
            <strong><%= time %></strong>：
            平均混雑度：<%= (time_congestions.sum(&:level).to_f / time_congestions.size).round(1) %>
            （<%= time_congestions.size %>件）
          </div>
        <% end %>
      <% else %>
        <p>データがありません</p>
      <% end %>

    </div>
  <% end %>
</div>

<%= link_to '編集', edit_shop_path(@shop), class: 'btn btn-warning' %>
<%= link_to '一覧に戻る', shops_path, class: 'btn btn-secondary' %>

<h2 class="mt-4">レビュー</h2>

<% if user_signed_in? %>
  <%= form_with model: [@shop, Review.new], local: true do |f| %>
    <div class="mb-3">
      <%= f.label :rating, "評価（1〜5）" %>
      <%= f.number_field :rating, in: 1..5, class: "form-control" %>
    </div>
    <div class="mb-3">
      <%= f.label :content, "レビュー内容" %>
      <%= f.text_area :content, class: "form-control" %>
    </div>
    <%= f.submit "投稿", class: "btn btn-primary" %>
  <% end %>
<% else %>
  <p>レビュー投稿にはログインが必要です。</p>
<% end %>

<hr>

<h3>混雑情報を投稿する</h3>
<%= form_with model: [@shop, Congestion.new], local: true do |f| %>
  <div class="mb-3">
    <%= f.label :visited_on, "訪問日" %>
    <%= f.date_field :visited_on, class: "form-control" %>
  </div>
  <div class="mb-3">
    <%= f.label :visited_time, "訪問時間帯" %>
    <%= f.select :visited_time, Congestion::VISITED_TIME_SLOTS, {}, class: "form-control" %>
  </div>
  <div class="mb-3">
    <%= f.label :level, "混雑度（1〜5）" %>
    <%= f.number_field :level, in: 1..5, class: "form-control" %>
  </div>
  <%= f.submit "投稿", class: "btn btn-primary" %>
<% end %>

<hr>

<% @reviews.each do |review| %>
  <div class="border rounded p-2 mb-2">
    <strong><%= review.user.name %></strong>（評価: <%= review.rating %>）  
    <p><%= review.content %></p>
    <% if review.user == current_user && review.id.present? %>
      <%= button_to "削除", shop_review_path(@shop, review), method: :delete, data: { turbo_confirm: "削除しますか？" }, class: "btn btn-sm btn-outline-danger" %>
    <% end %>
  </div>
<% end %>
